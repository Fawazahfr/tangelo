<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.min.css" />
<link rel="stylesheet" href="../static/genericWidget.css"/>
<link rel="stylesheet" href="../static/grid.css"/>

<script src="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.all.js"></script>
<script type='text/javascript' src="../static/clock.js"></script>

<div class="grid-stack"></div>

<script type="text/javascript">
  var grid = GridStack.init();

  // subscribe to this widget by widget_id, and display on dashboard
  followWidget = function (follow_widget_id) {
    let new_subscription = {
      grid_location: {
        x: 0,
        y: 0,
        w: 6,
        h: 2,
      },
      widget_id: follow_widget_id};
    $.ajax({
      type : 'POST',
      url : "{{url_for('addSubscription')}}",
      data : JSON.stringify({"subscription": new_subscription}),
      dataType: "json",
      contentType: "application/json",
      success: function (response) {
        window.location.reload();
           window.location();
         },
    });
  };

  removeWidget = function () {
    grid.removeAll()
    document.getElementById("display").value = "removed";
  };

  function saveData() {
    let widgets = [];

    $('.grid-stack-item.ui-draggable').each(function () {
        var $this = $(this);
        widgets.push({
           widget_id: $this.attr('widget-id') * 1,
           grid_location: {
              x: $this.attr('data-gs-x') * 1,
              y: $this.attr('data-gs-y') * 1,
              w: $this.attr('data-gs-width') * 1,
              h: $this.attr('data-gs-height') * 1}
            // content: $('.grid-stack-item-content', $this).html()7
        });
    });

    $.ajax({
      type : 'POST',
      url : "{{url_for('updateDashboard')}}",
      data : JSON.stringify({"data": widgets}),
      dataType: "json",
      contentType: "application/json",
    });
  };

  window.onload = function() {

    let displayedWidgets = JSON.parse('{{ displayedWidgets | tojson | safe}}');
    console.log(displayedWidgets);
    grid.removeAll()
    grid = GridStack.init();
    for (var i = 0; i < displayedWidgets.length; ++i) {

      let node =  {
          x: displayedWidgets[i].grid_location.x,
          y: displayedWidgets[i].grid_location.y,
          width: displayedWidgets[i].grid_location.w,
          height: displayedWidgets[i].grid_location.h,
          widget_name: displayedWidgets[i].widget_name,
          widget_post: displayedWidgets[i].widget_post,
          id: displayedWidgets[i].widget_id,
          widget_style: displayedWidgets[i].widget_style
      };
      if (!node.widget_style || node.widget_style.length === 0) {
        grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}">
                          <div class="grid-stack-item-content">
                              <div class = "centerPanelWidget">
                                <h3 class = "genericTitle">${node.widget_name}</h3>
                                <hr class = "genericDivider">
                                <div class = "GenericPost">
                                    <a class = "GenericPoster">
                                      @${node.widget_post.author}</a>
                                    ${node.widget_post.content}
                                </div>
                              </div>
                          </div>
                        </div>`, node);
      } else {
        grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}">
                          <div class="grid-stack-item-content">
                              <div class = "centerPanelWidget">
                                ${node.widget_style}
                              </div>
                          </div>
                        </div>`, node);
      }
    }
  };
</script>
