<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.min.css" />
<link rel="stylesheet" href="../static/grid.css"/>

<script src="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.all.js"></script>
<script type='text/javascript' src="../static/clock.js"></script>
<!-- <button class="btn btn-white btn-primary" id="addwidget" type="submit">Add Widget</button> -->

<div><a class="btn btn-outline-info" onClick="addNewWidget()" href="#">&nbsp;&nbsp;&nbsp;&nbsp;Add Clock&nbsp;&nbsp;&nbsp;</a></div><br>
<!-- <div><a class="btn btn-outline-info" onClick="removeWidget()" href="#">Remove Clock</a></div><br> -->
<div><a class="btn btn-outline-info" onClick="saveData()" href="#">Save Widgets</a></div><br>
<!-- <div><a class="btn btn-outline-info" onClick="loadData()" href="#">Load Widgets</a></div><br> -->


<div class="grid-stack"></div>
<script type="text/javascript">
  var grid = GridStack.init();

  addNewWidget = function () {
    let node =  {
        x: 0,
        y: 0,
        width: 6,
        height: 2,
        minWidth: 4,
        minHeight: 2
    };
    grid.addWidget('<div class="grid-stack-item" widget-id="5"><div class="grid-stack-item-content"><link rel="stylesheet" href="../static/clock.css"><br><div id="centerPanel"><h2 id="time"></h2><br><br><h2 id = "date"></h2></div></div></div>', node);
  };

  removeWidget = function () {
    grid.removeAll()
    document.getElementById("display").value = "removed";
  };

  function saveData() {
    let widgets = [];

    $('.grid-stack-item.ui-draggable').each(function () {
        var $this = $(this);
        widgets.push({
           widget_id: $this.attr('widget-id') * 1,
           grid_location: {
              x: $this.attr('data-gs-x') * 1,
              y: $this.attr('data-gs-y') * 1,
              w: $this.attr('data-gs-width') * 1,
              h: $this.attr('data-gs-height') * 1}
            // content: $('.grid-stack-item-content', $this).html()
        });
    });

    $.ajax({
      type : 'POST',
      url : "{{url_for('updateDashboard')}}",
      data : JSON.stringify({"data": widgets}),
      dataType: "json",
      contentType: "application/json",
    });

    alert(JSON.stringify(widgets));
  };

  window.onload = function() {

    let displayedWidgets = JSON.parse('{{ displayedWidgets | tojson | safe}}');
    console.log(displayedWidgets);
    grid.removeAll()
    grid = GridStack.init();
    for (var i = 0; i < displayedWidgets.length; ++i) {
      // $.each(displayeWidgets[i], function(key, value) {
      // console.log(key, value);
      // });
      let node =  {
          x: displayedWidgets[i].grid_location.x,
          y: displayedWidgets[i].grid_location.y,
          width: displayedWidgets[i].grid_location.w,
          height: displayedWidgets[i].grid_location.h,
          content: displayedWidgets[i].content,
          id: displayedWidgets[i].widget_id
      };
      console.log(node)
      grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}"><div class="grid-stack-item-content"><div>${node.content}</div></div></div>`, node);
    }

  };


</script>
