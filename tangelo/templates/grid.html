<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.min.css" />
<link rel="stylesheet" href="../static/genericWidget.css"/>
<link rel="stylesheet" href="../static/grid.css"/>

<!-- Icons -->
<script type="module" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>


<script src="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.all.js"></script>
<div id="mainGridContainer" style="transition: border .3s ease-in-out; border: 2px dashed #fafafa">
  <div class="container" id=step1>
    <div class="grid-stack"></div>
  </div>
</div>

<script type="text/javascript">
  var grid = GridStack.init({
    removable: '#trash',
    removeTimeout: 100
  });
  // don't perform any dashboard widget updates until all widgets are loaded
  let dashboardPopulated = false;

  // load dashboard
  window.onload = function() {

    // preserve newlines, etc - use valid JSON
    function escape (key, val) {
      if (typeof(val) != "string") return val;
      return val
        .replace(/[\"]/g, '\\"')
        .replace(/[\\]/g, '\\\\')
        .replace(/[\/]/g, '\\/')
        .replace(/[\b]/g, '\\b')
        .replace(/[\f]/g, '\\f')
        .replace(/[\n]/g, '\\n')
        .replace(/[\r]/g, '\\r')
        .replace(/[\t]/g, '\\t')
      ;
    }


    let displayed = JSON.parse(JSON.stringify({{ displayedWidgets | tojson }}));

    grid.removeAll()
    for (var i = 0; i < displayed.length; ++i) {

      let node =  {
          x: Math.round(displayed[i].grid_location.x),
          y: displayed[i].grid_location.y,
          width: displayed[i].grid_location.width,
          height: displayed[i].grid_location.height,
          minWidth: displayed[i].grid_location.minWidth,
          minHeight: displayed[i].grid_location.minHeight,
          widget_name: displayed[i].widget_name,
          widget_post: displayed[i].widget_post,
          id: displayed[i].widget_id,
          widget_style: displayed[i].widget_style,
          admin: displayed[i].widget_admin
      };
      if (!node.widget_style || node.widget_style.trim().length === 0) {
        // generic widget with empty post
        if (!node.widget_post.content || node.widget_post.content.trim().length === 0) {
            grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}">
                            <div class="grid-stack-item-content">
                              ${node.admin ? `<a href="#" onClick ="updateButton(this)" class="updateButton">	&#9998;</a>` : ''}
                              <div class = "centerPanelWidget">
                                <h3 class = "genericTitle">${node.widget_name}</h3>
                                <hr class = "genericDivider">
                              </div>
                            </div>
                          </div>`, node);
        } else {
          // generic widget with non-empty post
          grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}">
                            <div class="grid-stack-item-content">
                              ${node.admin ? `<a href="#" onClick ="updateButton(this)" class="updateButton">	&#9998;</a>` : ''}
                              <div class = "centerPanelWidget">
                                <h3 class = "genericTitle">${node.widget_name}</h3>
                                <hr class = "genericDivider">
                                <div class = "GenericPost">
                                    <div class = "GenericPostContent"><a class = "GenericPoster">@${node.widget_post.author}</a>${node.widget_post.content}</div>
                                </div>
                              </div>
                            </div>
                          </div>`, node);
        }
      } else {
        // our unique non-generic widgets
        grid.addWidget(`<div class="grid-stack-item" widget-id="${node.id}">
                          <div class="grid-stack-item-content">
                            ${node.widget_style}
                          </div>
                        </div>`, node);
      }
    }

    var grid_height = document.querySelector(".grid-stack").getAttribute("data-gs-current-column");
    var grid_width = document.querySelector(".grid-stack").getAttribute("data-gs-current-row");

    // bring all widgets to front, so each appears above sidebar and navbar when dragged
    for (const element of document.querySelectorAll(".grid-stack-item")) {
      element.style.zIndex = 1001;
    }
    dashboardPopulated = true;
  }

  // subscribe to this widget by widget_id, and display on dashboard
  followWidget = function (follow_widget_id) {
    let new_subscription = {
      widget_id: follow_widget_id,
      grid_location: {
        x: 0,
        y: 0,
        width: 6,
        height: 2,
      }
    };
    $.ajax({
      type : 'POST',
      url : "{{url_for('addSubscription')}}",
      data : JSON.stringify({"subscription": new_subscription}),
      dataType: "json",
      contentType: "application/json",
      success: function (response) {
        window.location.reload();
           window.location();
         },
    });
  };

  // update widget grid_location for each widget that has been removed, added, changed
  function updateGrid(e, items) {
    if (dashboardPopulated) {
      let widgets = []
      items.forEach(function(item) {
        widgets.push({
          widget_id: item.id * 1,
          grid_location: {
            x: item.x * 1,
            y: item.y * 1,
            width: item.width * 1,
            height: item.height * 1}
        });
      });
      $.ajax({
        type : 'POST',
        url : 'update/' + e.type,
        data : JSON.stringify({"widgets": widgets}),
        dataType: "json",
        contentType: "application/json",
        success: function (response) {
          searchFollowWidgets();
        },
      });
    }
  };


  function dragstart(event) {
    jQuery.event.props.push('dataTransfer');
    event.dataTransfer.setData('text/html', null); //cannot be empty string
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "medium dashed orange";
  }

  function allowDrop(event) {
  event.preventDefault();
  }
  function dragend(event) {
    event.preventDefault();
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "none";
  }

  var bkgdcolor;

  function updateButton(widget_target) {
    document.querySelector(".postPopup").style.display = "flex";
    document.querySelector(".postPopup").style.opacity = "100%";
    document.querySelector(".postPopup").style.zIndex = 1004;

    document.getElementsByClassName("navbar")[0].style.zIndex = 1002;

    var w = $(window).width();
    var h = $(window).height();
    var $overlay = $('<div/>', {
      'id': 'overlay',
      css: {
        position   : 'absolute',
        height     : h + 'px',
        width      : w + 'px',
        left       : 0,
        top        : 0,
        background : '#000',
        opacity    : 0.3,
        zIndex     : 1003
     }
   }).appendTo('body');
   // alert(widget_target.parentNode.parentNode.getAttribute("widget-id"));
 // Click overlay to remove
  }
  function closeUpdate() {
    document.querySelector(".postPopup").style.display = "none";
    document.querySelector(".postPopup").style.opacity = "0";
    document.getElementById("overlay").remove();
    document.getElementsByClassName("navbar")[0].style.zIndex = 1020;
  }
  function submitPost() {
    closeUpdate();
  }

  grid.on('dragstart', function(event, ui) {
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "2px dashed orange";
  });

  grid.on('dragstop', function(event, ui) {
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "2px dashed #fafafa";
  });

  grid.on('resizestart', function(event, ui) {
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "2px dashed orange";
  });

  grid.on('gsresizestop', function(event, element) {
    var grid = document.getElementById("mainGridContainer");
    grid.style.border = "2px dashed #fafafa";
  });

  grid.on('added removed change', updateGrid);

</script>
